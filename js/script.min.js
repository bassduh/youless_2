var loadingEnabled=false,tmpWatt=new Array()
function requestLiveData(){var selected_meter=$('select[name=selected_meter]').val();$.ajax({url:'ajax.php?a=live',dataType:'json',success:function(json){var interval=$('#settingsOverlay').data('liveinterval'),shiftMax=6e4/interval;for(var i=0;i<json.length;i++){if(chart.series.length<json.length){var addseries={id:i,name:json[i].name,marker:{radius:0},data:[]};chart.addSeries(addseries);$('#wattCounter').append('<span>'+json[i].name+': <span class=wattCounter_'+i+'></span></span>');tmpWatt[i]=0};var series=chart.series[i],shift=series.data.length>shiftMax,x=(new Date()).getTime(),y=json[i]["pwr"];chart.series[i].addPoint([x,y],false,shift);if(tmpWatt[i]<parseInt(json[i]["pwr"])){updown="countUp"}else if(tmpWatt[i]==parseInt(json[i]["pwr"])){updown=""}else updown="countDown";tmpWatt[i]=parseInt(json[i]["pwr"]);$('.wattCounter_'+i).html("<span class='"+updown+"'>"+json[i]["pwr"]+" Watt</span>")};chart.redraw();setTimeout(requestLiveData,interval)},cache:false})}
function calculate(target,date){$.ajax({url:'ajax.php?a=calculate_'+target+'&date='+date,dataType:'json',success:function(jsonData){for(var i=0;i<jsonData.length;i++){if($('input[name=dualcount]:checked').val()==1){$('#sidebar .'+target+' .kwhCounter').append('<span>'+jsonData[i]['name']+': <br>L: <span class="price">€ '+jsonData[i]['priceLow']+'</span><span class="kwh">'+jsonData[i]['kwhLow']+' kWh</span><br>H: <span class="price">€ '+jsonData[i]['price']+'</span><span class="kwh">'+jsonData[i]['kwh']+' kWh</span></span>')}else $('#sidebar .'+target+' .kwhCounter').append('<span>'+jsonData[i]['name']+': <br><span class="price">€ '+jsonData[i]['price']+'</span><span class="kwh">'+jsonData[i]['kwh']+' kWh</span></span>');$('.sidebarLoading').remove()}},cache:false})}
function createChart(target,date){if(loadingEnabled){historychart.showLoading()}else loadingEnabled=true;$('#sidebar .'+target+' .kwhCounter').html("<span class='sidebarLoading'>Loading…</span>");var selected_meter=$('select[name=selected_meter]').val();$.ajax({url:'ajax.php?a='+target+'&date='+date,dataType:'json',success:function(jsonData){if(jsonData.ok==0){$('#message').text(jsonData.msg);$('#overlay').fadeIn()};if(target=='week'){var type='areaspline',serieName='Watt',rangeSelector=true,navScroll=true,pointInterval=60*1e3,tickInterval=null,plotLines=[{value:jsonData[0].start+(24*60*60*1e3),width:1,color:'#c0c0c0'},{value:jsonData[0].start+(2*24*60*60*1e3),width:1,color:'#c0c0c0'},{value:jsonData[0].start+(3*24*60*60*1e3),width:1,color:'#c0c0c0'},{value:jsonData[0].start+(4*24*60*60*1e3),width:1,color:'#c0c0c0'},{value:jsonData[0].start+(5*24*60*60*1e3),width:1,color:'#c0c0c0'},{value:jsonData[0].start+(6*24*60*60*1e3),width:1,color:'#c0c0c0'}],buttons=[{type:'hour',count:1,text:'1u'},{type:'hour',count:12,text:'12u'},{type:'day',count:1,text:'dag'},{type:'week',count:1,text:'week'}]}else if(target=='day'){var type='areaspline',rangeSelector=false,navScroll=false,pointInterval=60*1e3,tickInterval=null,plotLines=null,buttons=[{type:'hour',count:1,text:'1u'},{type:'hour',count:12,text:'12u'},{type:'day',count:1,text:'dag'}]}else if(target=='month'){var type='column',serieName='kWh',rangeSelector=false,navScroll=false,pointInterval=24*60*60*1e3,tickInterval=24*60*60*1e3,plotLines=null,buttons=[]};historychart=new Highcharts.StockChart({chart:{renderTo:'history',type:type,margin:[50,20,70,50]},credits:{enabled:false},legend:{enabled:true},title:{text:null},yAxis:{showFirstLabel:false,title:{text:'',margin:40}},xAxis:{type:'datetime',tickInterval:tickInterval,plotLines:plotLines},rangeSelector:{buttons:buttons,enabled:rangeSelector},navigator:{enabled:navScroll},scrollbar:{enabled:navScroll},series:[]});for(var i=0;i<jsonData.length;i++){historychart.yAxis[0].setTitle({text:jsonData[i].unit});var addseries={id:i,name:jsonData[i].name,turboThreshold:5e3,pointStart:jsonData[i].start,pointInterval:pointInterval,tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y} '+jsonData[i].unit+'</b><br/>',valueDecimals:0},data:jsonData[i].val};historychart.addSeries(addseries)};calculate(target,date)},cache:false})};$(document).ready(function(){$('#closeDialog').click(function(){$('#overlay').hide();$('#dialog').removeClass();$('#dialog').addClass('default')});if($('#update_notification').length>0)$('#update_notification').delay(2e3).slideDown('slow').delay(5e3).slideUp('slow');$('#showSettings').click(function(){$('#settingsOverlay').slideDown()});$('#hideSettings').click(function(){$('#settingsOverlay').slideUp(function(){var dualcnt=$('input[name=dualcount]:checked').val();if(dualcnt!=$('#settingsOverlay').data('dualcount')){$('input[name=dualcount]').not(':checked').attr('checked',true);if($('#settingsOverlay').data('dualcount')==1){$('.cpkwhlow').show()}else $('.cpkwhlow').hide()}})});$('#settingsMenu .btn li a').click(function(){var tab=$(this).data('settingstab');$('.settingsTab').hide();$('#'+tab).show();$('#settingsMenu .btn li').each(function(){$(this).removeClass('selected')});$(this).parent().addClass('selected')});$('input[name=dualcount]').change(function(){var dualcnt=$('input[name=dualcount]:checked').val();if(dualcnt==1){$('.cpkwhlow').show()}else $('.cpkwhlow').hide()});$('.viewChangelog').click(function(){$('#overlay').fadeIn();$('#message').text('Loading...');$.ajax({url:'ajax.php?a=getChangelog',success:function(data){$('#dialog').removeClass('default');$('#dialog').addClass('size500x250');$('#message').html(data)}});return false});$('.delMeter').click(function(){var meter=$(this).data('meter');$.ajax({url:'ajax.php?a=delMeter',type:'POST',dataType:'json',data:{meter:meter},success:function(data){$('#message').text(data.msg);$('#overlay').fadeIn()}});return false});$('.addMeter').click(function(){var rows=$('.meter_row input[name=meter_key]').length;if(rows==0){$('#settingsMeters tr:first').after('<tr class="meter_row"><td><input type="hidden" name="meter[0][id]" value=""/><input type="hidden" name="meter_key" value="0"/><input type="text" name="meter[0][name]" value=""/></td><td><input type="text" name="meter[0][address]" value=""/></td><td><input type="text" name="meter[0][password]" value=""/></td><td><a class="smallBtn delBtn">Verwijder</a></td></tr>')}else{var key=parseInt($('.meter_row:last input[name=meter_key]').val())+1;$('.meter_row:last').after('<tr class="meter_row"><td><input type="hidden" name="meter['+key+'][id]" value=""/><input type="hidden" name="meter_key" value="'+key+'"/><input type="text" name="meter['+key+'][name]" value=""/></td><td><input type="text" name="meter['+key+'][address]" value=""/></td><td><input type="text" name="meter['+key+'][password]" value=""/></td><td><a class="smallBtn delBtn">Verwijder</a></td></tr>')};return false});$('#saveSettings').click(function(){$.ajax({url:'ajax.php?a=saveSettings',type:'POST',dataType:'json',data:$('#settingsOverlay form').serialize(),success:function(data){$('#settingsOverlay').slideUp('fast',function(){$('#settingsOverlay input[type=password]').val('')});if($('#settingsOverlay').data('dualcount')!=$('input[name=dualcount]:checked').val()){$('#settingsOverlay').data('dualcount',$('input[name=dualcount]:checked').val());var chart=$('#history').data('chart');calculate(chart,$('#datepicker').val())};$('#settingsOverlay').data('liveinterval',$('select[name=liveinterval]').val());$('#message').text(data.msg);$('#overlay').fadeIn()}});return false});$('.showChart').click(function(){var chart=$(this).data('chart');$('.chart').hide();$('.'+chart).show();$('#menu .btn li').each(function(){$(this).removeClass('selected')});$(this).parent().addClass('selected');$('#history').data('chart',chart);if(chart!='live')createChart(chart,$('#datepicker').val())});Highcharts.setOptions({global:{useUTC:false},lang:{decimalPoint:',',months:['Januari','Februari','Maart','April','Mei','Juni','Juli','Augustus','September','Oktober','November','December'],shortMonths:['Jan','Feb','Mrt','Apr','Mei','Jun','Jul','Aug','Sep','Okt','Nov','Dec'],weekdays:['Zondag','Maandag','Dinsdag','Woensdag','Donderdag','Vrijdag','Zaterdag']}});chart=new Highcharts.Chart({chart:{renderTo:'live',defaultSeriesType:'areaspline',margin:[50,20,70,50],events:{load:requestLiveData}},credits:{enabled:false},legend:{enabled:true,margin:40},title:{text:null},xAxis:{type:'datetime',tickPixelInterval:150,minRange:60*1e3},yAxis:{showFirstLabel:false,minPadding:0.2,maxPadding:0.2,title:{text:'Watt',margin:40}},series:[],exporting:{enabled:false}});$('#datepicker').datepicker({inline:true,dateFormat:'yy-mm-dd',maxDate:new Date(),showOn:'focus',firstDay:1,monthNames:['Januari','Februari','Maart','April','Mei','Juni','Juli','Augustus','September','Oktober','November','December'],monthNamesShort:['jan','feb','maa','apr','mei','jun','jul','aug','sep','okt','nov','dec'],dayNames:['zondag','maandag','dinsdag','woensdag','donderdag','vrijdag','zaterdag'],dayNamesShort:['zon','maa','din','woe','don','vri','zat'],dayNamesMin:['zo','ma','di','wo','do','vr','za'],onSelect:function(date,inst){var target=$('#history').data('chart');createChart(target,date)}})})